name: Wormhole - SDK Type Check

on:
  workflow_call:
    inputs:
      package_manager:
        description: Package manager to use for install/typecheck steps (npm or yarn).
        type: string
        required: false
        default: npm

permissions:
  contents: read
  issues: write

jobs:
  typecheck-latest:
    runs-on: ubuntu-latest

    steps:
      # Fetch repository code
      - name: Checkout repo
        uses: actions/checkout@v4

      # Install Node.js runtime with dependency cache
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: ${{ inputs.package_manager == 'yarn' && 'yarn' || 'npm' }}

      - name: Enable Corepack for Yarn
        if: inputs.package_manager == 'yarn'
        run: corepack enable

      # Install dependencies from lockfile
      - name: Install dependencies (locked versions)
        run: |
          set -euo pipefail
          case "${{ inputs.package_manager }}" in
            yarn)
              yarn_version=$(yarn --version)
              if [[ "$yarn_version" == 1.* ]]; then
                yarn install --frozen-lockfile
              else
                yarn install --immutable
              fi
              ;;
            npm)
              npm ci
              ;;
            *)
              echo "Unsupported package_manager: ${{ inputs.package_manager }} (use npm or yarn)"
              exit 1
              ;;
          esac

      # Override Wormhole SDK to latest for this run
      - name: Override Wormhole SDK to @latest
        run: |
          set -euo pipefail
          case "${{ inputs.package_manager }}" in
            yarn)
              yarn_version=$(yarn --version)
              if [[ "$yarn_version" == 1.* ]]; then
                yarn add --dev @wormhole-foundation/sdk@latest --no-lockfile
              else
                yarn add --dev @wormhole-foundation/sdk@latest
              fi
              ;;
            npm)
              npm install --no-save --force @wormhole-foundation/sdk@latest
              ;;
            *)
              echo "Unsupported package_manager: ${{ inputs.package_manager }} (use npm or yarn)"
              exit 1
              ;;
          esac

      # Resolve and record the SDK version installed
      - name: Resolve Wormhole SDK version
        id: sdk-version
        run: |
          set +e
          node <<'EOF'
          const fs = require('fs');
          const path = require('path');
          const pkgPath = path.join(process.cwd(), 'node_modules', '@wormhole-foundation', 'sdk', 'package.json');
          let version = 'unknown';
          try {
            if (fs.existsSync(pkgPath)) {
              const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));
              if (pkg.version) version = pkg.version;
              else console.warn('Version not found in @wormhole-foundation/sdk package.json');
            } else {
              console.warn('Could not find node_modules/@wormhole-foundation/sdk/package.json');
            }
          } catch (err) {
            console.warn(`Could not determine SDK version: ${err.message}`);
          }
          console.log(`Using @wormhole-foundation/sdk@${version}`);
          if (process.env.GITHUB_OUTPUT) {
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `sdk_version=${version}\n`);
          }
          EOF

      # Run typecheck, capture logs, and record result
      - name: Type check against latest SDK
        id: typecheck
        continue-on-error: true # allow flow to continue even when typecheck fails
        run: |
          sdk_version="${{ steps.sdk-version.outputs.sdk_version }}"
          echo "Running typecheck against @wormhole-foundation/sdk@${sdk_version:-unknown}"
          set -o pipefail
          set +e
          if [ "${{ inputs.package_manager }}" = "yarn" ]; then
            yarn run typecheck 2>&1 | tee typecheck.log
          else
            npm run typecheck 2>&1 | tee typecheck.log
          fi
          exit_code=${PIPESTATUS[0]}
          set -e
          tail -n 200 typecheck.log > typecheck.tail.log || true
          {
            printf 'exit_code=%s\n' "$exit_code"
            printf 'failed=%s\n' "$( [ "$exit_code" -ne 0 ] && echo true || echo false )"
            printf 'log<<EOF\n'
            cat typecheck.tail.log 2>/dev/null || true
            printf '\nEOF\n'
          } >> "$GITHUB_OUTPUT"

      # Open a GitHub issue when typecheck fails on schedule or manual run
      - name: Create issue on failure
        if: steps.typecheck.outputs.failed == 'true' && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            try {
              const { repo, owner } = context.repo;
              const fs = require('fs');
              const path = require('path');
              const title = "Demo fails typecheck with latest Wormhole SDK";
              const exitCodeRaw = '${{ steps.typecheck.outputs.exit_code }}';
              const parsedExitCode = Number.parseInt(exitCodeRaw, 10);
              const exitCode = Number.isNaN(parsedExitCode) ? exitCodeRaw : parsedExitCode;
              const workspace = process.env.GITHUB_WORKSPACE || process.cwd();
              const logPath = path.join(workspace, 'typecheck.log');
              let log = '(no output captured)';
              try {
                const rawLog = fs.readFileSync(logPath, 'utf8');
                const maxChars = 6000;
                const truncatedRaw = rawLog.length > maxChars ? rawLog.slice(-maxChars) : rawLog;
                const lines = truncatedRaw.split(/\r?\n/);
                const snippet = lines.slice(-200).join('\n').trim();
                if (snippet.length > 0) log = snippet;
              } catch (readError) {
                core.warning(`Unable to read typecheck output: ${readError.message}`);
              }
              const body = [
                '**What happened**',
                'The scheduled canary workflow detected a typecheck or build failure when testing with the latest version of `@wormhole-foundation/sdk`.',
                '',
                `**Commit:** ${context.sha}`,
                '',
                '**TypeScript errors:**',
                '```',
                log,
                '```',
                '_This issue was created automatically by the Canary CI job._'
              ].join('\n');

              const { data: issue } = await github.rest.issues.create({
                owner,
                repo,
                title,
                body
              });
              core.notice(`Opened issue ${issue.html_url}`);
            } catch (error) {
              core.setFailed(`Issue automation failed: ${error instanceof Error ? error.message : String(error)}`);
            }

      - name: Fail job when typecheck fails
        if: steps.typecheck.outputs.failed == 'true'
        run: exit 1
