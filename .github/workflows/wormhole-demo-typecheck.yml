name: Wormhole - SDK Type Check

on:
  workflow_call:

permissions:
  contents: read
  issues: write

jobs:
  typecheck-latest:
    runs-on: ubuntu-latest

    steps:
      # Fetch repository code
      - name: Checkout repo
        uses: actions/checkout@v4

      # Install Node.js runtime with npm cache
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # Install dependencies from lockfile
      - name: Install dependencies (locked versions)
        run: npm ci

      # Override Wormhole SDK to latest without persisting to lockfile
      - name: Override Wormhole SDK to @latest
        run: |
          npm install --no-save --force @wormhole-foundation/sdk@latest
          npm ls @wormhole-foundation/sdk --depth=0 || true

      # Resolve and record the SDK version installed
      - name: Resolve Wormhole SDK version
        id: sdk-version
        run: |
          set -e
          version=$(node -p "require('@wormhole-foundation/sdk/package.json').version")
          echo "Using @wormhole-foundation/sdk@$version"
          echo "sdk_version=$version" >> "$GITHUB_OUTPUT"

      # Run typecheck, capture logs, and record result
      - name: Type check against latest SDK
        id: typecheck
        continue-on-error: true # allow flow to continue even when typecheck fails
        run: |
          sdk_version="${{ steps.sdk-version.outputs.sdk_version }}"
          echo "Running typecheck against @wormhole-foundation/sdk@${sdk_version:-unknown}"
          set -o pipefail
          set +e
          npm run typecheck 2>&1 | tee typecheck.log
          exit_code=${PIPESTATUS[0]}
          set -e
          tail -n 200 typecheck.log > typecheck.tail.log || true
          {
            printf 'exit_code=%s\n' "$exit_code"
            printf 'failed=%s\n' "$( [ "$exit_code" -ne 0 ] && echo true || echo false )"
            printf 'log<<EOF\n'
            cat typecheck.tail.log 2>/dev/null || true
            printf '\nEOF\n'
          } >> "$GITHUB_OUTPUT"

      # Open a GitHub issue when typecheck fails on schedule or manual run
      - name: Create issue on failure
        if: steps.typecheck.outputs.failed == 'true' && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            try {
              const { repo, owner } = context.repo;
              const fs = require('fs');
              const path = require('path');
              const title = "Demo fails typecheck with latest Wormhole SDK";
              const exitCodeRaw = '${{ steps.typecheck.outputs.exit_code }}';
              const parsedExitCode = Number.parseInt(exitCodeRaw, 10);
              const exitCode = Number.isNaN(parsedExitCode) ? exitCodeRaw : parsedExitCode;
              const workspace = process.env.GITHUB_WORKSPACE || process.cwd();
              const logPath = path.join(workspace, 'typecheck.log');
              let log = '(no output captured)';
              try {
                const rawLog = fs.readFileSync(logPath, 'utf8');
                const maxChars = 6000;
                const truncatedRaw = rawLog.length > maxChars ? rawLog.slice(-maxChars) : rawLog;
                const lines = truncatedRaw.split(/\r?\n/);
                const snippet = lines.slice(-200).join('\n').trim();
                if (snippet.length > 0) log = snippet;
              } catch (readError) {
                core.warning(`Unable to read typecheck output: ${readError.message}`);
              }
              const body = [
                '**What happened**',
                'The scheduled canary workflow detected a typecheck or build failure when testing with the latest version of `@wormhole-foundation/sdk`.',
                '',
                `**Commit:** ${context.sha}`,
                '',
                '**TypeScript errors:**',
                '```',
                log,
                '```',
                '_This issue was created automatically by the Canary CI job._'
              ].join('\n');

              const { data: issue } = await github.rest.issues.create({
                owner,
                repo,
                title,
                body
              });
              core.notice(`Opened issue ${issue.html_url}`);
            } catch (error) {
              core.setFailed(`Issue automation failed: ${error instanceof Error ? error.message : String(error)}`);
            }

      - name: Fail job when typecheck fails
        if: steps.typecheck.outputs.failed == 'true'
        run: exit 1